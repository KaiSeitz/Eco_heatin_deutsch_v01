blueprint:
  name: Heizung nach Anwesenheit + Fenster (mehrere Heizungen)
  description: >
    Steuert mehrere Heizungen gemeinsam.
    - Startet erst ab „Morgen-Startzeit“
    - Mindestens eine Person zuhause => Anwesenheits-Temperatur
    - Niemand zuhause => nach Verzögerung Abwesenheits-Temperatur
    - Fenster offen => Heizungen AUS
    Feste Personen: person.emiliaseitz + person.kaiseitz
    Optional: weitere Personen/Tracker ergänzen.

  domain: automation

  input:
    climate_entities:
      name: Heizungen (eine oder mehrere)
      description: Wähle die Thermostate / Climate-Entities, die gemeinsam gesteuert werden sollen.
      selector:
        entity:
          multiple: true
          domain: climate

    window_entities:
      name: Fensterkontakte (optional)
      description: Wenn einer davon „offen“ ist, werden die Heizungen ausgeschaltet.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - binary_sensor
            - input_boolean

    morning_start:
      name: Morgen-Startzeit
      description: Ab dieser Uhrzeit beginnt die Steuerung (vorher wird nichts verändert).
      default: "06:00:00"
      selector:
        time:

    extra_presence_entities:
      name: Zusätzliche Anwesenheit (optional)
      description: Weitere Personen (person.*) oder Tracker (device_tracker.*), die als „zuhause“ zählen.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - person
            - device_tracker

    away_delay_seconds:
      name: Verzögerung bis Abwesenheit (Sekunden)
      description: Wenn niemand zuhause ist, so lange warten, bevor auf Abwesenheits-Temperatur gestellt wird.
      default: 300
      selector:
        number:
          min: 5
          max: 1800
          step: 5
          unit_of_measurement: seconds
          mode: slider

    temp_present:
      name: Temperatur bei Anwesenheit
      description: Temperatur, wenn mindestens eine Person zuhause ist.
      default: 21
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    temp_away:
      name: Temperatur bei Abwesenheit
      description: Temperatur, wenn niemand zuhause ist (nach Verzögerung).
      default: 18
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

mode: restart
max_exceeded: silent

variables:
  climates: !input climate_entities
  windows: !input window_entities
  extra_presence: !input extra_presence_entities
  morning_start: !input morning_start

  anyone_home: >-
    {% set base = ['person.emiliaseitz', 'person.kaiseitz'] %}
    {% set all_entities = base + (extra_presence | list) %}
    {{ expand(all_entities) | selectattr('state','eq','home') | list | count > 0 }}

  any_window_open: >-
    {% if windows is none or (windows | length) == 0 %}
      false
    {% else %}
      {{
        expand(windows)
        | selectattr('state','eq','on')
        | list | count > 0
      }}
    {% endif %}

trigger:
  # Start morgens
  - platform: time
    at: !input morning_start

  # Anwesenheit ändert sich (feste Personen)
  - platform: state
    entity_id:
      - person.emiliaseitz
      - person.kaiseitz

  # Anwesenheit ändert sich (optional zusätzliche)
  - platform: state
    entity_id: !input extra_presence_entities

  # Fensterstatus ändert sich
  - platform: state
    entity_id: !input window_entities

  # Sicherheits-Trigger
  - platform: time_pattern
    minutes: "/5"

condition:
  # Vor Morgen-Startzeit: nichts tun
  - condition: template
    value_template: >-
      {{ now() >= today_at(morning_start) }}

action:
  - choose:
      # Fenster offen => Heizungen AUS
      - conditions:
          - condition: template
            value_template: "{{ any_window_open }}"
        sequence:
          - service: climate.turn_off
            target:
              entity_id: !input climate_entities

      # Niemand zuhause => warten => wenn immer noch niemand zuhause + Fenster zu: Abwesenheits-Temp
      - conditions:
          - condition: template
            value_template: "{{ not anyone_home }}"
        sequence:
          - delay:
              seconds: !input away_delay_seconds
          - condition: template
            value_template: "{{ not anyone_home }}"
          - condition: template
            value_template: "{{ not any_window_open }}"
          - service: climate.set_temperature
            target:
              entity_id: !input climate_entities
            data:
              temperature: !input temp_away

    default:
      # Jemand zuhause + Fenster zu => Anwesenheits-Temp
      - condition: template
        value_template: "{{ anyone_home }}"
      - condition: template
        value_template: "{{ not any_window_open }}"
      - service: climate.set_temperature
        target:
          entity_id: !input climate_entities
        data:
          temperature: !input temp_present
