blueprint:
  name: Heizungssteuerung nach Anwesenheit + Fenster (Multi-Heizungen) + Nachtmodus
  description: >
    Steuert eine oder mehrere Heizungen (climate.*) nach Anwesenheit.
    - Aktivzeit: von Startzeit bis Endzeit.
    - Innerhalb Aktivzeit: Anwesenheit steuert Temperatur.
    - Außerhalb Aktivzeit (Nachtmodus): feste Nacht-Temperatur (bis Startzeit).
    - Fenster offen: Heizungen AUS (hat immer Vorrang).

  domain: automation

  input:
    heaters:
      name: Heizungen
      description: Eine oder mehrere Climate-Entities auswählen, die gemeinsam gesteuert werden.
      selector:
        entity:
          domain: climate
          multiple: true

    windows:
      name: Fensterkontakt(e)
      description: Wenn mindestens einer dieser Kontakte „on“ ist (offen), werden die Heizungen ausgeschaltet.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - binary_sensor
            - input_boolean

    start_time:
      name: Startzeit (morgens)
      description: Ab dieser Uhrzeit ist die Anwesenheits-Steuerung aktiv.
      default: "06:00:00"
      selector:
        time:

    end_time:
      name: Endzeit (abends)
      description: Ab dieser Uhrzeit gilt Nachtmodus (bis zur Startzeit).
      default: "23:00:00"
      selector:
        time:

    temp_night:
      name: Nacht-Temperatur
      description: Temperatur im Nachtmodus (zwischen Endzeit und Startzeit).
      default: 17
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    away_delay:
      name: Verzögerung bei Abwesenheit (Sekunden)
      description: Wenn niemand zuhause ist, so lange warten, bevor Abwesenheits-Temperatur gesetzt wird (nur innerhalb Aktivzeit).
      default: 300
      selector:
        number:
          min: 5
          max: 1800
          step: 5
          unit_of_measurement: seconds
          mode: slider

    temp_present:
      name: Temperatur bei Anwesenheit
      description: Wird gesetzt, wenn mindestens eine Person zuhause ist (nur innerhalb Aktivzeit).
      default: 21
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    temp_away:
      name: Temperatur bei Abwesenheit
      description: Wird gesetzt, wenn niemand zuhause ist (nach Verzögerung, nur innerhalb Aktivzeit).
      default: 18
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    extra_presence:
      name: Zusätzliche Personen/Tracker (optional)
      description: Weitere person.* oder device_tracker.* hinzufügen, die als „zuhause“ zählen sollen.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - person
            - device_tracker

mode: restart
max_exceeded: silent

variables:
  v_windows: !input windows
  v_extra_presence: !input extra_presence
  v_start: !input start_time
  v_end: !input end_time

  v_presence_all: >-
    {{ ['person.emiliaseitz', 'person.kaiseitz'] + (v_extra_presence | list) }}

  anyone_home: >-
    {{ expand(v_presence_all) | selectattr('state','eq','home') | list | count > 0 }}

  any_window_open: >-
    {% if v_windows is none or (v_windows | length) == 0 %}
      false
    {% else %}
      {{ expand(v_windows) | selectattr('state','eq','on') | list | count > 0 }}
    {% endif %}

  in_active_time: >-
    {% set now_t = now() %}
    {% set start_t = today_at(v_start) %}
    {% set end_t = today_at(v_end) %}
    {{ now_t >= start_t and now_t < end_t }}

trigger:
  - platform: time
    at: !input start_time
  - platform: time
    at: !input end_time

  - platform: state
    entity_id:
      - person.emiliaseitz
      - person.kaiseitz

  - platform: state
    entity_id: !input extra_presence

  - platform: state
    entity_id: !input windows

  - platform: time_pattern
    minutes: "/5"

action:
  - choose:
      # Fenster offen -> Heizungen AUS
      - conditions:
          - condition: template
            value_template: "{{ any_window_open }}"
        sequence:
          - service: climate.turn_off
            target:
              entity_id: !input heaters

      # Nachtmodus (außerhalb Aktivzeit) -> Nacht-Temp (Fenster muss zu sein)
      - conditions:
          - condition: template
            value_template: "{{ not in_active_time }}"
        sequence:
          - service: climate.set_temperature
            target:
              entity_id: !input heaters
            data:
              temperature: !input temp_night

      # Aktivzeit: niemand zuhause -> warten -> wenn immer noch niemand zuhause + Fenster zu -> Abwesenheits-Temp
      - conditions:
          - condition: template
            value_template: "{{ in_active_time and (not anyone_home) }}"
        sequence:
          - delay:
              seconds: !input away_delay
          - condition: template
            value_template: "{{ in_active_time and (not anyone_home) and (not any_window_open) }}"
          - service: climate.set_temperature
            target:
              entity_id: !input heaters
            data:
              temperature: !input temp_away

    default:
      # Aktivzeit: jemand zuhause + Fenster zu -> Anwesenheits-Temp
      - condition: template
        value_template: "{{ in_active_time and anyone_home and (not any_window_open) }}"
      - service: climate.set_temperature
        target:
          entity_id: !input heaters
        data:
          temperature: !input temp_present
