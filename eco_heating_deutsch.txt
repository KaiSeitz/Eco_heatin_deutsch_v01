blueprint:
  name: Heizungssteuerung nach Anwesenheit + Fenster (Multi-Heizungen)
  description: >
    Steuert eine oder mehrere Heizungen (climate.*) nach Anwesenheit.
    - Startet erst ab einer frei wählbaren Uhrzeit (Morgen-Start).
    - Mindestens eine Person zuhause => Anwesenheits-Temperatur.
    - Niemand zuhause => nach Verzögerung Abwesenheits-Temperatur.
    - Wenn ein Fenster offen ist => Heizungen werden ausgeschaltet (climate.turn_off).

  domain: automation

  input:
    heaters:
      name: Heizungen
      description: Eine oder mehrere Climate-Entities auswählen, die gemeinsam gesteuert werden.
      selector:
        entity:
          domain: climate
          multiple: true

    windows:
      name: Fensterkontakt(e)
      description: Wenn mindestens einer dieser Kontakte „on“ ist (offen), werden die Heizungen ausgeschaltet.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - binary_sensor
            - input_boolean

    morning_start:
      name: Morgen-Startzeit
      description: Ab dieser Uhrzeit beginnt die Automatik (vorher wird nichts verändert).
      default: "06:00:00"
      selector:
        time:

    away_delay:
      name: Verzögerung bei Abwesenheit (Sekunden)
      description: Wenn niemand zuhause ist, so lange warten, bevor Abwesenheits-Temperatur gesetzt wird.
      default: 300
      selector:
        number:
          min: 5
          max: 1800
          step: 5
          unit_of_measurement: seconds
          mode: slider

    temp_present:
      name: Temperatur bei Anwesenheit
      description: Wird gesetzt, wenn mindestens eine Person zuhause ist.
      default: 21
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    temp_away:
      name: Temperatur bei Abwesenheit
      description: Wird gesetzt, wenn niemand zuhause ist (nach Verzögerung).
      default: 18
      selector:
        number:
          min: 5
          max: 35
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    extra_presence:
      name: Zusätzliche Personen/Tracker (optional)
      description: Weitere person.* oder device_tracker.* hinzufügen, die als „zuhause“ zählen sollen.
      default: []
      selector:
        entity:
          multiple: true
          domain:
            - person
            - device_tracker

mode: restart
max_exceeded: silent

variables:
  v_heaters: !input heaters
  v_windows: !input windows
  v_morning_start: !input morning_start
  v_extra_presence: !input extra_presence

  v_presence_all: >-
    {{ ['person.emiliaseitz', 'person.kaiseitz'] + (v_extra_presence | list) }}

  anyone_home: >-
    {{ expand(v_presence_all) | selectattr('state','eq','home') | list | count > 0 }}

  any_window_open: >-
    {% if v_windows is none or (v_windows | length) == 0 %}
      false
    {% else %}
      {{ expand(v_windows) | selectattr('state','eq','on') | list | count > 0 }}
    {% endif %}

trigger:
  # Start der Automatik am Morgen
  - platform: time
    at: !input morning_start

  # Anwesenheit ändert sich (feste Personen)
  - platform: state
    entity_id:
      - person.emiliaseitz
      - person.kaiseitz

  # Anwesenheit ändert sich (zusätzliche Entities)
  - platform: state
    entity_id: !input extra_presence

  # Fenster ändert sich
  - platform: state
    entity_id: !input windows

  # Safety: alle 5 Minuten
  - platform: time_pattern
    minutes: "/5"

condition:
  # Vor der Morgen-Startzeit: keine Steuerung
  - condition: template
    value_template: "{{ now() >= today_at(v_morning_start) }}"

action:
  - choose:
      # Fenster offen -> Heizungen AUS
      - conditions:
          - condition: template
            value_template: "{{ any_window_open }}"
        sequence:
          - service: climate.turn_off
            target:
              entity_id: !input heaters

      # Niemand zuhause -> warten -> wenn immer noch niemand zuhause und Fenster zu -> Abwesenheits-Temp
      - conditions:
          - condition: template
            value_template: "{{ not anyone_home }}"
        sequence:
          - delay:
              seconds: !input away_delay
          - condition: template
            value_template: "{{ not anyone_home }}"
          - condition: template
            value_template: "{{ not any_window_open }}"
          - service: climate.set_temperature
            target:
              entity_id: !input heaters
            data:
              temperature: !input temp_away

    default:
      # Jemand zuhause und Fenster zu -> Anwesenheits-Temp
      - condition: template
        value_template: "{{ anyone_home }}"
      - condition: template
        value_template: "{{ not any_window_open }}"
      - service: climate.set_temperature
        target:
          entity_id: !input heaters
        data:
          temperature: !input temp_present
